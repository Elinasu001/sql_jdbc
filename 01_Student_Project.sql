-- =========================
-- SAFE DROP (없으면 무시)
-- =========================
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE TB_STUDENTS CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE TB_DORMITORY CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE TB_MAJOR CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;

BEGIN
  EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_STUDENTNO';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -2289 THEN RAISE; END IF; END;

BEGIN
  EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_DORMITORYNO';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -2289 THEN RAISE; END IF; END;

BEGIN
  EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_MAJORNO';
EXCEPTION WHEN OTHERS THEN IF SQLCODE != -2289 THEN RAISE; END IF; END;


-- =========================
-- 테이블 재생성
-- =========================
CREATE TABLE TB_MAJOR (
    MAJOR_ID        NUMBER PRIMARY KEY,
    MAJOR_NAME      NVARCHAR2(30) NOT NULL,
    DEPARTMENT_NAME NVARCHAR2(30) NOT NULL,
    CREDIT_HOURS    NUMBER NOT NULL
);

CREATE TABLE TB_DORMITORY (
    DORM_ID      NUMBER PRIMARY KEY,
    DORM_NAME    NVARCHAR2(30) NOT NULL,
    DORM_LOCATION NVARCHAR2(30) NOT NULL,
    DORM_LEADER  NVARCHAR2(30) NOT NULL
);

CREATE TABLE TB_STUDENTS (
    STUDENT_ID   NUMBER PRIMARY KEY,
    STUDENT_NAME NVARCHAR2(20) NOT NULL,
    BIRTH_DATE   DATE NOT NULL,
    GENDER       CHAR(1) CHECK (GENDER IN ('M','F')) NOT NULL,
    ENROLL_DATE  DATE NOT NULL,
    DELETE_YN    CHAR(1) DEFAULT 'N',
    MAJOR_ID     NUMBER,
    DORM_ID      NUMBER,
    CONSTRAINT FK_TB_STUDENTS_MAJOR FOREIGN KEY (MAJOR_ID) REFERENCES TB_MAJOR(MAJOR_ID),
    CONSTRAINT FK_TB_STUDENTS_DORM  FOREIGN KEY (DORM_ID)  REFERENCES TB_DORMITORY(DORM_ID)
);

-- =========================
-- 시퀀스 재생성 (STUDENT는 1000부터)
-- =========================
CREATE SEQUENCE SEQ_MAJORNO
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

CREATE SEQUENCE SEQ_DORMITORYNO
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

CREATE SEQUENCE SEQ_STUDENTNO
  START WITH 1000              
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

-- =========================
-- 샘플 데이터
-- =========================
INSERT INTO TB_MAJOR (MAJOR_ID, MAJOR_NAME, DEPARTMENT_NAME, CREDIT_HOURS) VALUES (1, '컴퓨터공학', '공학부', 140);
INSERT INTO TB_MAJOR (MAJOR_ID, MAJOR_NAME, DEPARTMENT_NAME, CREDIT_HOURS) VALUES (2, '경영학', '경영학부', 130);
INSERT INTO TB_MAJOR (MAJOR_ID, MAJOR_NAME, DEPARTMENT_NAME, CREDIT_HOURS) VALUES (3, '심리학', '심리학부', 120);
INSERT INTO TB_MAJOR (MAJOR_ID, MAJOR_NAME, DEPARTMENT_NAME, CREDIT_HOURS) VALUES (4, '생물학', '자연과학부', 120);
INSERT INTO TB_MAJOR (MAJOR_ID, MAJOR_NAME, DEPARTMENT_NAME, CREDIT_HOURS) VALUES (5, '영어영문학', '인문학부', 120);

INSERT INTO TB_DORMITORY (DORM_ID, DORM_NAME, DORM_LOCATION, DORM_LEADER) VALUES (1, '하나관',  '서울캠퍼스', '김철수');
INSERT INTO TB_DORMITORY (DORM_ID, DORM_NAME, DORM_LOCATION, DORM_LEADER) VALUES (2, '둘리관',  '서울캠퍼스', '이영희');
INSERT INTO TB_DORMITORY (DORM_ID, DORM_NAME, DORM_LOCATION, DORM_LEADER) VALUES (3, '삼성관',  '부산캠퍼스', '박민수');
INSERT INTO TB_DORMITORY (DORM_ID, DORM_NAME, DORM_LOCATION, DORM_LEADER) VALUES (4, '네오관',  '부산캠퍼스', '최지은');
INSERT INTO TB_DORMITORY (DORM_ID, DORM_NAME, DORM_LOCATION, DORM_LEADER) VALUES (5, '다섯관',  '대구캠퍼스', '정우성');

-- 학생은 시퀀스로 넣기(1000부터 5건 → 1000~1004)
INSERT INTO TB_STUDENTS (STUDENT_ID, STUDENT_NAME, BIRTH_DATE, GENDER, ENROLL_DATE, DELETE_YN, MAJOR_ID, DORM_ID)
VALUES (SEQ_STUDENTNO.NEXTVAL, '김민수', TO_DATE('2000-05-15','YYYY-MM-DD'), 'M', TO_DATE('2019-03-01','YYYY-MM-DD'), 'N', 1, 1);

INSERT INTO TB_STUDENTS (STUDENT_ID, STUDENT_NAME, BIRTH_DATE, GENDER, ENROLL_DATE, DELETE_YN, MAJOR_ID, DORM_ID)
VALUES (SEQ_STUDENTNO.NEXTVAL, '이영희', TO_DATE('1999-08-22','YYYY-MM-DD'), 'F', TO_DATE('2018-03-01','YYYY-MM-DD'), 'N', 2, 2);

INSERT INTO TB_STUDENTS (STUDENT_ID, STUDENT_NAME, BIRTH_DATE, GENDER, ENROLL_DATE, DELETE_YN, MAJOR_ID, DORM_ID)
VALUES (SEQ_STUDENTNO.NEXTVAL, '박철수', TO_DATE('2001-12-30','YYYY-MM-DD'), 'M', TO_DATE('2020-03-01','YYYY-MM-DD'), 'N', 3, 3);

INSERT INTO TB_STUDENTS (STUDENT_ID, STUDENT_NAME, BIRTH_DATE, GENDER, ENROLL_DATE, DELETE_YN, MAJOR_ID, DORM_ID)
VALUES (SEQ_STUDENTNO.NEXTVAL, '최지은', TO_DATE('2000-03-10','YYYY-MM-DD'), 'F', TO_DATE('2019-03-01','YYYY-MM-DD'), 'N', 4, 4);

INSERT INTO TB_STUDENTS (STUDENT_ID, STUDENT_NAME, BIRTH_DATE, GENDER, ENROLL_DATE, DELETE_YN, MAJOR_ID, DORM_ID)
VALUES (SEQ_STUDENTNO.NEXTVAL, '정우성', TO_DATE('1998-11-05','YYYY-MM-DD'), 'M', TO_DATE('2017-03-01','YYYY-MM-DD'), 'N', 5, 5);

COMMIT;

SELECT * FROM TB_STUDENTS ORDER BY STUDENT_ID;

--1.-----
SELECT 
       S.STUDENT_ID 
     , S.STUDENT_NAME
     , S.ENROLL_DATE
     , M.MAJOR_NAME
     , D.DORM_NAME
 FROM
       TB_STUDENTS S
 JOIN 
 	   TB_MAJOR M ON S.MAJOR_ID = M.MAJOR_ID
 JOIN 
 	   TB_DORMITORY D ON S.DORM_ID = D.DORM_ID
 WHERE
        S.DELETE_YN = 'N'
 ORDER
    BY
       S.STUDENT_ID;

--2.------
SELECT
       S.STUDENT_ID
     , S.STUDENT_NAME
     , S.ENROLL_DATE
     , M.MAJOR_NAME
     , D.DORM_NAME
  FROM
       TB_STUDENTS S
 JOIN 
 	   TB_MAJOR M ON S.MAJOR_ID = M.MAJOR_ID
 JOIN 
       TB_DORMITORY D ON S.DORM_ID = D.DORM_ID
 WHERE
       S.DELETE_YN = 'N'
   AND
       S.STUDENT_ID = 1003;

--3.--
SELECT
      S.STUDENT_ID
    , S.STUDENT_NAME
    , S.ENROLL_DATE
    , M.MAJOR_NAME
    , D.DORM_NAME
 FROM
      TB_STUDENTS S
 JOIN 
      TB_MAJOR M ON S.MAJOR_ID = M.MAJOR_ID
 JOIN 
      TB_DORMITORY D ON S.DORM_ID = D.DORM_ID
WHERE
      S.DELETE_YN = 'N'
  AND
      D.DORM_NAME = '하나관';


--4.--
SELECT
       S.STUDENT_ID
     , S.STUDENT_NAME    
     , S.ENROLL_DATE
     , M.MAJOR_NAME
     , M.DEPARTMENT_NAME
     , M.CREDIT_HOURS
  FROM
       TB_STUDENTS S
  JOIN 
 	   TB_MAJOR M ON S.MAJOR_ID = M.MAJOR_ID
 WHERE
       S.DELETE_YN = 'N'
   AND
       M.MAJOR_NAME = '경영학'; 


--5.--
SELECT       
       S.STUDENT_ID 
     , S.STUDENT_NAME     
     , S.ENROLL_DATE
     , M.MAJOR_NAME
     , D.DORM_NAME
  FROM
       TB_STUDENTS S
  JOIN 
 	   TB_MAJOR M ON S.MAJOR_ID = M.MAJOR_ID
  JOIN 
       TB_DORMITORY D ON S.DORM_ID = D.DORM_ID
 WHERE
        S.DELETE_YN = 'N' AND S.STUDENT_NAME = '컴퓨터공학';

--6.--
UPDATE 
       TB_STUDENTS
   SET 
       MAJOR_ID = (
		    SELECT 
		           MAJOR_ID
		      FROM 
		           TB_MAJOR
	         WHERE 
		           MAJOR_NAME = '경영학'
		)
 WHERE 
        STUDENT_ID = 1001;

SELECT * FROM TB_MAJOR;

--7--
UPDATE 
       TB_STUDENTS
   SET 
       DORM_ID = (
		    SELECT 
		           DORM_ID
		      FROM 
		           TB_DORMITORY
		     WHERE 
		           DORM_NAME = '둘리관'
		)
 WHERE STUDENT_ID = 1001;

SELECT * FROM TB_STUDENTS;

--8.--

INSERT 
  INTO 
       TB_STUDENTS
       (
       STUDENT_ID
     , STUDENT_NAME
     , BIRTH_DATE
     , GENDER
     , ENROLL_DATE
     , DELETE_YN
     , MAJOR_ID
     , DORM_ID
       ) 
VALUES 
       (
       SEQ_STUDENTNO.NEXTVAL
     , '이재욱'
     , TO_DATE('2002-04-29', 'YYYY-MM-DD')
     , 'F'
     , TO_DATE('2021-03-01', 'YYYY-MM-DD')
     , 'N'
	 , (
	   SELECT 
			  MAJOR_ID
		 FROM 
			  TB_MAJOR 
		WHERE 
			  MAJOR_NAME = '컴퓨터공학'
	    )
      , (
		SELECT 
		       DORM_ID
		  FROM 
		       TB_DORMITORY 
		 WHERE 
	           DORM_NAME = '하나관'
      )); 

SELECT * FROM TB_STUDENTS;

--9.--
--UPDATE 
--       TB_STUDENT
--   SET 
--       DELETE_YN = 'Y'
-- WHERE 
--       STUDENT_ID = 1001; 

UPDATE 
       TB_STUDENTS
   SET 
       DELETE_YN = 'Y'
 WHERE 
       STUDENT_ID = 1006 AND STUDENT_NAME = '김태희';

SELECT * FROM TB_STUDENTS;

